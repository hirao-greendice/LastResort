<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>謎解き公演 - 小部屋画面</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier Prime', monospace;
            background: #000000;
            color: #ffffff;
            height: 100vh;
            user-select: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }
        
        .special-buttons {
            display: flex;
            gap: 100px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .special-button {
            width: 180px;
            height: 144px;
            font-size: 26px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            font-family: 'Courier Prime', monospace;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .noise-button {
            background: #808080;
            color: #000000;
        }
        
        .noise-button.active {
            background: #ffff00;
            color: #000000;
        }
        
        .window-button {
            background: #ffff00;
            color: #000000;
        }
        
        .window-button.off {
            background: #808080;
            color: #000000;
        }
        
        .doctor-button {
            background: #0066aa;
            color: #ffffff;
        }
        
        .doctor-button.off {
            background: #808080;
            color: #000000;
        }
        
        .scenario-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .scenario-button {
            width: 180px;
            height: 144px;
            background: #00aa00;
            color: #000000;
            border: none;
            font-family: 'Courier Prime', monospace;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .scenario-button:hover {
            background: #00dd00;
        }
        
        .scenario-button.active {
            background: #88ff88;
        }
        
        .scenario-name {
            font-size: 15px;
            margin-bottom: 5px;
        }
        
        .scenario-command {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .scenario-key {
            font-size: 22px;
            font-weight: 700;
        }
        
        .reset-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 120px;
            height: 80px;
            background: #00aa00;
            color: #000000;
            border: none;
            font-family: 'Courier Prime', monospace;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .reset-button:hover {
            background: #00dd00;
        }
        
        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            padding: 10px 20px;
            background: #333333;
            color: #ffffff;
            border: none;
            font-family: 'Courier Prime', monospace;
            font-size: 18px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .back-button:hover {
            background: #555555;
        }
        
        .fullscreen-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 80px;
            background: #0066aa;
            color: #ffffff;
            border: none;
            font-family: 'Courier Prime', monospace;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .fullscreen-button:hover {
            background: #0088dd;
        }
        
        .status {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #ffff00;
        }
        
        /* 接続状況表示パネル */
        .connection-panel {
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffffff;
            border-radius: 5px;
            padding: 15px;
            font-size: 14px;
            font-family: 'Courier Prime', monospace;
            min-width: 200px;
        }
        
        .connection-title {
            font-size: 16px;
            font-weight: 700;
            color: #ffff00;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .connection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .connection-name {
            font-weight: 700;
            color: #ffffff;
        }
        
        .connection-status {
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .status-online {
            background: #00aa00;
            color: #000000;
        }
        
        .status-offline {
            background: #aa0000;
            color: #ffffff;
        }
        
        .status-unknown {
            background: #888888;
            color: #ffffff;
        }
        
        .last-seen {
            font-size: 11px;
            color: #888888;
            text-align: center;
            margin-top: 10px;
            border-top: 1px solid #333;
            padding-top: 5px;
        }
        
        .self-status {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #00ffff;
        }
        
        /* 確認ダイアログのスタイル */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: 'Courier Prime', monospace;
        }
        
        .dialog-content {
            background: #222222;
            border: 3px solid #ffffff;
            padding: 40px;
            text-align: center;
            color: #ffffff;
            max-width: 500px;
            width: 80%;
        }
        
        .dialog-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #ffff00;
        }
        
        .dialog-message {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.4;
        }
        
        .dialog-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .dialog-button {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Courier Prime', monospace;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }
        
        .dialog-button.yes {
            background: #00aa00;
            color: #000000;
        }
        
        .dialog-button.yes:hover {
            background: #00dd00;
        }
        
        .dialog-button.no {
            background: #aa0000;
            color: #ffffff;
        }
        
        .dialog-button.no:hover {
            background: #dd0000;
        }
        
        /* レスポンシブ対応 */
                 @media (max-width: 800px) {
             .connection-panel {
                 right: 5px;
                 top: 40px;
                 min-width: 180px;
                 padding: 10px;
             }
             
             .connection-title {
                 font-size: 14px;
             }
             
             .connection-item {
                 margin: 6px 0;
             }
             
             .special-buttons {
                 gap: 50px;
             }
            
            .special-button {
                width: 144px;
                height: 120px;
                font-size: 23px;
            }
            
            .scenario-buttons {
                gap: 10px;
            }
            
            .scenario-button {
                width: 144px;
                height: 120px;
                font-size: 18px;
            }
            
            .scenario-name {
                font-size: 13px;
            }
            
            .scenario-command {
                font-size: 18px;
            }
            
            .scenario-key {
                font-size: 20px;
            }
        }
        
                 @media (max-width: 600px) {
             .special-buttons {
                 flex-direction: column;
                 gap: 15px;
             }
            
            .special-button {
                width: 240px;
                height: 96px;
                font-size: 23px;
            }
            
            .scenario-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .scenario-button {
                width: 240px;
            }
            
            .reset-button {
                bottom: 20px;
                right: 20px;
                width: 100px;
                height: 60px;
                font-size: 16px;
            }
            
            .fullscreen-button {
                bottom: 20px;
                left: 20px;
                width: 100px;
                height: 60px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="status" id="connectionStatus">Firebase接続中...</div>
    
    <!-- 接続状況表示パネル -->
    <div class="connection-panel" id="connectionPanel">
        <div class="connection-title">端末接続状況</div>
        <div class="connection-item self-status">
            <span class="connection-name">小部屋</span>
            <span class="connection-status status-online">ONLINE</span>
        </div>
        <div class="connection-item" id="windowConnection">
            <span class="connection-name">窓</span>
            <span class="connection-status status-unknown">---</span>
        </div>
        <div class="connection-item" id="monitorConnection">
            <span class="connection-name">モニター</span>
            <span class="connection-status status-unknown">---</span>
        </div>
        <div class="connection-item" id="doctorConnection">
            <span class="connection-name">博士映像</span>
            <span class="connection-status status-unknown">---</span>
        </div>
        <div class="last-seen" id="lastUpdate">最終更新: --:--:--</div>
    </div>
    
    <a href="index.html" class="back-button">← メニュー</a>
    
    <div class="special-buttons">
        <button class="special-button noise-button" id="imageToggleBtn" onclick="toggleImageDisplay()">
            ノイズ<br>OFF
        </button>
        
        <button class="special-button window-button off" id="windowToggleBtn" onclick="confirmToggleWindowChange()">
            窓変化<br>OFF
        </button>
        
        <button class="special-button doctor-button off" id="doctorToggleBtn" onclick="toggleDoctorVideo()">
            博士映像<br>OFF
        </button>
    </div>
    
    <div class="scenario-buttons">
        <button class="scenario-button" onclick="confirmSelectScenario(1)">
            <div class="scenario-name">アロハ</div>
            <div class="scenario-command">LAND</div>
            <div class="scenario-key">A</div>
        </button>
        
        <button class="scenario-button" onclick="confirmSelectScenario(2)">
            <div class="scenario-name">クイーン</div>
            <div class="scenario-command">FLAG</div>
            <div class="scenario-key">Q</div>
        </button>
        
        <button class="scenario-button" onclick="confirmSelectScenario(3)">
            <div class="scenario-name">ストリート</div>
            <div class="scenario-command">EDIT</div>
            <div class="scenario-key">S</div>
        </button>
        
        <button class="scenario-button" onclick="confirmSelectScenario(4)">
            <div class="scenario-name">ゾンビ</div>
            <div class="scenario-command">UNIT</div>
            <div class="scenario-key">Z</div>
        </button>
        
        <button class="scenario-button" onclick="confirmSelectScenario(5)">
            <div class="scenario-name">ゾンビ</div>
            <div class="scenario-command">VIEW</div>
            <div class="scenario-key">Z</div>
        </button>
        
        <button class="scenario-button" onclick="confirmSelectScenario(6)">
            <div class="scenario-name">ゾンビ</div>
            <div class="scenario-command">LIVE</div>
            <div class="scenario-key">U</div>
        </button>
    </div>
    
    <button class="reset-button" onclick="confirmResetMonitor()">
        画面<br>リセット
    </button>
    
    <button class="fullscreen-button" onclick="toggleFullscreen()">
        全画面<br>切替
    </button>
    
    <!-- 確認ダイアログ -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="dialog-content">
            <div class="dialog-title">確認</div>
            <div class="dialog-message" id="dialogMessage">このシナリオを実行しますか？</div>
            <div class="dialog-buttons">
                <button class="dialog-button yes" onclick="confirmYes()">ハイ</button>
                <button class="dialog-button no" onclick="confirmNo()">いいえ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCMqH0u_bO2knTMMSDjzwKbQBECUdzlwnc",
            authDomain: "lastr-36807.firebaseapp.com",
            databaseURL: "https://lastr-36807-default-rtdb.firebaseio.com",
            projectId: "lastr-36807",
            storageBucket: "lastr-36807.firebasestorage.app",
            messagingSenderId: "1068261467238",
            appId: "1:1068261467238:web:22c701f8879d6bb61c79a7",
            measurementId: "G-1S8C9GC4GY"
        };

        try {
            const app = initializeApp(firebaseConfig);
            
            // Cloud Firestore
            const firestore = getFirestore(app);
            
            // Realtime Database
            const database = getDatabase(app);

            // グローバルにエクスポート
            window.firestore = firestore;
            window.database = database;
            window.firestoreDoc = doc;
            window.firestoreSetDoc = setDoc;
            window.firestoreOnSnapshot = onSnapshot;
            window.firestoreCollection = collection;
            window.firestoreGetDoc = getDoc;
            window.dbRef = ref;
            window.dbSet = set;
            window.dbOnValue = onValue;
            window.serverTimestamp = () => new Date();

            // 接続テスト（両方を試す）
            console.log('Testing Firebase connections...');
            
            // Firestore接続テスト（読み取り専用）
            const testFirestoreRef = doc(firestore, 'gameData', 'scenarios');
            const unsubscribe = onSnapshot(testFirestoreRef, (snapshot) => {
                console.log('Firestore connection successful');
                document.getElementById('connectionStatus').textContent = 'Firebase接続状態: Firestore接続済み ✓';
                document.getElementById('connectionStatus').style.color = '#00ff00';
                window.useFirestore = true;
                loadScenarios();
                unsubscribe(); // 一度テストしたら解除
            }, (firestoreError) => {
                console.log('Firestore connection failed:', firestoreError);
                
                // Realtime Database接続テスト
                const testRef = ref(database, '.info/connected');
                onValue(testRef, (snapshot) => {
                    const connected = snapshot.val();
                    if (connected) {
                        console.log('Realtime Database connection successful');
                        document.getElementById('connectionStatus').textContent = 'Firebase接続状態: Realtime Database接続済み ✓';
                        document.getElementById('connectionStatus').style.color = '#00ff00';
                        window.useFirestore = false;
                        loadScenarios();
                    } else {
                        console.log('Both Firebase services failed');
                        document.getElementById('connectionStatus').textContent = 'Firebase接続状態: 接続失敗 ✗';
                        document.getElementById('connectionStatus').style.color = '#ff0000';
                    }
                });
            });
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('connectionStatus').textContent = 'Firebase接続状態: 初期化エラー ✗';
            document.getElementById('connectionStatus').style.color = '#ff0000';
        }
    </script>
    
    <script>
        // 全画面機能
        function toggleFullscreen() {
            console.log('Toggle fullscreen clicked');
            console.log('Current fullscreen element:', document.fullscreenElement);
            
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                // 全画面にする
                const element = document.documentElement;
                if (element.requestFullscreen) {
                    element.requestFullscreen().then(() => {
                        console.log('Entered fullscreen successfully');
                    }).catch(err => {
                        console.error('Error entering fullscreen:', err);
                    });
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                    console.log('Entered webkit fullscreen');
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                    console.log('Entered ms fullscreen');
                } else {
                    console.error('Fullscreen not supported');
                }
            } else {
                // 全画面を解除
                if (document.exitFullscreen) {
                    document.exitFullscreen().then(() => {
                        console.log('Exited fullscreen successfully');
                    }).catch(err => {
                        console.error('Error exiting fullscreen:', err);
                    });
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                    console.log('Exited webkit fullscreen');
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                    console.log('Exited ms fullscreen');
                }
            }
        }
        
        // 自動全画面化スクリプトを削除
    </script>

    <script src="kobeya.js"></script>
</body>
</html>