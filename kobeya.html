<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>謎解き公演 - 小部屋画面</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier Prime', monospace;
            background: #000000;
            color: #ffffff;
            height: 100vh;
            user-select: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }
        
        .special-buttons {
            display: flex;
            gap: 200px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .special-button {
            width: 150px;
            height: 120px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            font-family: 'Courier Prime', monospace;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .noise-button {
            background: #808080;
            color: #000000;
        }
        
        .noise-button.active {
            background: #ffff00;
            color: #000000;
        }
        
        .window-button {
            background: #ffff00;
            color: #000000;
        }
        
        .window-button.off {
            background: #808080;
            color: #000000;
        }
        
        .scenario-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .scenario-button {
            width: 150px;
            height: 120px;
            background: #00aa00;
            color: #000000;
            border: none;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .scenario-button:hover {
            background: #00dd00;
        }
        
        .scenario-button.active {
            background: #88ff88;
        }
        
        .scenario-name {
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .scenario-command {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .scenario-key {
            font-size: 18px;
            font-weight: 700;
        }
        
        .reset-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 120px;
            height: 80px;
            background: #00aa00;
            color: #000000;
            border: none;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .reset-button:hover {
            background: #00dd00;
        }
        
        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            padding: 10px 20px;
            background: #333333;
            color: #ffffff;
            border: none;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .back-button:hover {
            background: #555555;
        }
        
        .fullscreen-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 80px;
            background: #0066aa;
            color: #ffffff;
            border: none;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .fullscreen-button:hover {
            background: #0088dd;
        }
        
        .status {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #ffff00;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 800px) {
            .special-buttons {
                gap: 100px;
            }
            
            .special-button {
                width: 120px;
                height: 100px;
                font-size: 16px;
            }
            
            .scenario-buttons {
                gap: 10px;
            }
            
            .scenario-button {
                width: 120px;
                height: 100px;
                font-size: 12px;
            }
            
            .scenario-command {
                font-size: 14px;
            }
            
            .scenario-key {
                font-size: 16px;
            }
        }
        
        @media (max-width: 600px) {
            .special-buttons {
                flex-direction: column;
                gap: 20px;
            }
            
            .special-button {
                width: 200px;
                height: 80px;
                font-size: 16px;
            }
            
            .scenario-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .scenario-button {
                width: 200px;
            }
            
            .reset-button {
                bottom: 20px;
                right: 20px;
                width: 100px;
                height: 60px;
                font-size: 12px;
            }
            
            .fullscreen-button {
                bottom: 20px;
                left: 20px;
                width: 100px;
                height: 60px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="status" id="connectionStatus">Firebase接続中...</div>
    
    <a href="index.html" class="back-button">← メニュー</a>
    
    <div class="special-buttons">
        <button class="special-button noise-button" id="imageToggleBtn" onclick="toggleImageDisplay()">
            ノイズ<br>OFF
        </button>
        
        <button class="special-button window-button off" id="windowToggleBtn" onclick="toggleWindowChange()">
            窓変化<br>OFF
        </button>
    </div>
    
    <div class="scenario-buttons">
        <button class="scenario-button" onclick="selectScenario(1)">
            <div class="scenario-name">アロハ</div>
            <div class="scenario-command">LAND</div>
            <div class="scenario-key">A</div>
        </button>
        
        <button class="scenario-button" onclick="selectScenario(2)">
            <div class="scenario-name">クイーン</div>
            <div class="scenario-command">FLAG</div>
            <div class="scenario-key">Q</div>
        </button>
        
        <button class="scenario-button" onclick="selectScenario(3)">
            <div class="scenario-name">ストリート</div>
            <div class="scenario-command">EDIT</div>
            <div class="scenario-key">S</div>
        </button>
        
        <button class="scenario-button" onclick="selectScenario(4)">
            <div class="scenario-name">ゾンビ</div>
            <div class="scenario-command">UNIT</div>
            <div class="scenario-key">Z</div>
        </button>
        
        <button class="scenario-button" onclick="selectScenario(5)">
            <div class="scenario-name">ゾンビ</div>
            <div class="scenario-command">VIEW</div>
            <div class="scenario-key">Z</div>
        </button>
    </div>
    
    <button class="reset-button" onclick="resetMonitor()">
        画面<br>リセット
    </button>
    
    <button class="fullscreen-button" onclick="toggleFullscreen()">
        全画面<br>切替
    </button>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCMqH0u_bO2knTMMSDjzwKbQBECUdzlwnc",
            authDomain: "lastr-36807.firebaseapp.com",
            databaseURL: "https://lastr-36807-default-rtdb.firebaseio.com",
            projectId: "lastr-36807",
            storageBucket: "lastr-36807.firebasestorage.app",
            messagingSenderId: "1068261467238",
            appId: "1:1068261467238:web:22c701f8879d6bb61c79a7",
            measurementId: "G-1S8C9GC4GY"
        };

        try {
            const app = initializeApp(firebaseConfig);
            
            // Cloud Firestore
            const firestore = getFirestore(app);
            
            // Realtime Database
            const database = getDatabase(app);

            // グローバルにエクスポート
            window.firestore = firestore;
            window.database = database;
            window.firestoreDoc = doc;
            window.firestoreSetDoc = setDoc;
            window.firestoreOnSnapshot = onSnapshot;
            window.firestoreCollection = collection;
            window.firestoreGetDoc = getDoc;
            window.dbRef = ref;
            window.dbSet = set;
            window.dbOnValue = onValue;
            window.serverTimestamp = () => new Date();

            // 接続テスト（両方を試す）
            console.log('Testing Firebase connections...');
            
            // Firestore接続テスト（読み取り専用）
            const testFirestoreRef = doc(firestore, 'gameData', 'scenarios');
            const unsubscribe = onSnapshot(testFirestoreRef, (snapshot) => {
                console.log('Firestore connection successful');
                document.getElementById('connectionStatus').textContent = 'Firebase接続状態: Firestore接続済み ✓';
                document.getElementById('connectionStatus').style.color = '#00ff00';
                window.useFirestore = true;
                loadScenarios();
                unsubscribe(); // 一度テストしたら解除
            }, (firestoreError) => {
                console.log('Firestore connection failed:', firestoreError);
                
                // Realtime Database接続テスト
                const testRef = ref(database, '.info/connected');
                onValue(testRef, (snapshot) => {
                    const connected = snapshot.val();
                    if (connected) {
                        console.log('Realtime Database connection successful');
                        document.getElementById('connectionStatus').textContent = 'Firebase接続状態: Realtime Database接続済み ✓';
                        document.getElementById('connectionStatus').style.color = '#00ff00';
                        window.useFirestore = false;
                        loadScenarios();
                    } else {
                        console.log('Both Firebase services failed');
                        document.getElementById('connectionStatus').textContent = 'Firebase接続状態: 接続失敗 ✗';
                        document.getElementById('connectionStatus').style.color = '#ff0000';
                    }
                });
            });
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('connectionStatus').textContent = 'Firebase接続状態: 初期化エラー ✗';
            document.getElementById('connectionStatus').style.color = '#ff0000';
        }
    </script>
    
    <script>
        // 全画面機能
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Error attempting to enable fullscreen:', err);
                });
            } else {
                document.exitFullscreen().catch(err => {
                    console.log('Error attempting to exit fullscreen:', err);
                });
            }
        }
        
        // デフォルトで全画面にする
        document.addEventListener('DOMContentLoaded', function() {
            // 少し遅延してから全画面にする（ブラウザの制限を回避）
            setTimeout(() => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('Auto fullscreen failed:', err);
                    });
                }
            }, 1000);
        });
    </script>

    <script src="kobeya.js"></script>
</body>
</html>